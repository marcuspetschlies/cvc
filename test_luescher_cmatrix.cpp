/****************************************************
 * test_luescher_cmatrix
 *
 ****************************************************/

#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <math.h>
#include <complex.h>
#include <time.h>
#ifdef HAVE_MPI
#  include <mpi.h>
#endif
#ifdef HAVE_OPENMP
#  include <omp.h>
#endif
#include <getopt.h>
#include "ranlxd.h"

#ifdef __cplusplus
extern "C"
{
#endif

#  ifdef HAVE_TMLQCD_LIBWRAPPER
#    include "tmLQCD.h"
#  endif

#ifdef __cplusplus
}
#endif

#define MAIN_PROGRAM

#include "cvc_complex.h"
#include "cvc_linalg.h"
#include "global.h"
#include "cvc_geometry.h"
#include "cvc_utils.h"
#include "mpi_init.h"
#include "io.h"
#include "read_input_parser.h"
#include "table_init_i.h"
#include "rotations.h"
#include "ranlxd.h"
#include "group_projection.h"
#include "little_group_projector_set.h"
#include "clebsch_gordan.h"

#define _DBL_GTR_EPS(_a,_b) ( fabs(_a)>(_b) ? _a : 0 )


using namespace cvc;

int main(int argc, char **argv) {

  double const eps_tiny = 1.e-14;

  int c;
  int filename_set = 0;
  char filename[100];
  int exitstatus;


#ifdef HAVE_MPI
  MPI_Init(&argc, &argv);
#endif

  while ((c = getopt(argc, argv, "h?f:")) != -1) {
    switch (c) {
      case 'f':
        strcpy(filename, optarg);
        filename_set=1;
        break;
      case 'h':
      case '?':
      default:
        fprintf(stdout, "# [test_luescher_cmatrix] exit\n");
        exit(1);
      break;
    }
  }


  /* set the default values */
  if( filename_set == 1 ) {
    fprintf(stdout, "# [test_luescher_cmatrix] Reading input from file %s\n", filename);
    read_input_parser(filename);
  }

  /****************************************************/
  /****************************************************/

  /****************************************************
   * initialize MPI parameters for cvc
   ****************************************************/
   mpi_init(argc, argv);

  /****************************************************/
  /****************************************************/

  /****************************************************
   * set number of openmp threads
   ****************************************************/
#ifdef HAVE_OPENMP
 if(g_cart_id == 0) fprintf(stdout, "# [test_luescher_cmatrix] setting omp number of threads to %d\n", g_num_threads);
 omp_set_num_threads(g_num_threads);
#pragma omp parallel
{
  fprintf(stdout, "# [test_luescher_cmatrix] proc%.4d thread%.4d using %d threads\n", g_cart_id, omp_get_thread_num(), omp_get_num_threads());
}
#else
  if(g_cart_id == 0) fprintf(stdout, "[test_luescher_cmatrix] Warning, resetting global thread number to 1\n");
  g_num_threads = 1;
#endif

  /****************************************************/
  /****************************************************/

  /****************************************************
   * initialize and set geometry fields
   ****************************************************/
  exitstatus = init_geometry();
  if( exitstatus != 0) {
    fprintf(stderr, "[test_luescher_cmatrix] Error from init_geometry, status was %d %s %d\n", exitstatus, __FILE__, __LINE__ );
    EXIT(1);
  }

  geometry();

  /****************************************************/
  /****************************************************/

  int const lmax = 4;

  for ( int l1 = 0; l1 <= lmax; l1 ++ ) {
    for ( int m1 = -l1; m1 <= l1; m1++ ) {

      for ( int l2 = 0; l2 <= lmax; l2 ++ ) {
        for ( int m2 = -l2; m2 <= l2; m2++ ) {

          int const jmin = abs( l1 -l2 );
          int const jmax = l1 + l2;

          for ( int j = jmin; j <= jmax; j++ ) {
            for ( int s = -j; s <= j; s++ ) {
              double _Complex const z = luescher_c_matrix ( l1, m1, j, s, l2, m2 );
              fprintf ( stdout, "%3d %3d    %3d %3d    %3d %3d    %25.16e %25.16e\n", l1, m1, j, s, l2, m2, 
                   _DBL_GTR_EPS(  creal(z), eps_tiny ),
                   _DBL_GTR_EPS( cimag(z) , eps_tiny ) );
            }
          }
        }
      }
    }
  }



  /****************************************************
   * finalize
   ****************************************************/
  free_geometry();

#ifdef HAVE_MPI
  MPI_Barrier(g_cart_grid);
#endif

  if(g_cart_id==0) {
    g_the_time = time(NULL);
    fprintf(stdout, "# [test_luescher_cmatrix] %s# [test_luescher_cmatrix] end of run\n", ctime(&g_the_time));
    fprintf(stderr, "# [test_luescher_cmatrix] %s# [test_luescher_cmatrix] end of run\n", ctime(&g_the_time));
  }

#ifdef HAVE_MPI
  mpi_fini_datatypes();
  MPI_Finalize();
#endif
  return(0);
}
